---
title: "simulations"
output: pdf_document
date: "2025-03-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
set.seed(123)
n=200
n_sim=1000
#library("WinRatio")
library(dplyr)
library(purrr)
library(ggplot2)
library(tidyr)
library(npsm)
library(bpcp)
library(survival)
```

```{r}
data("leuk2")
with(leuk2,Surv(time,status))
df= as.data.frame(with(leuk2,Surv(time,status)))
```

# Générer les données 

## Générer les fonctions

```{r, echo=TRUE}
gener_tte=function(mu, lambda=1){
  X=rexp(n, rate=lambda)
  C=rexp(n, rate = mu)
  TT=pmin(X,C)
  delta=as.numeric(X==TT)
  delta=abs(1-delta)
  S=Surv(time = TT, event = delta)
  S=as.data.frame(S)
  return(S)
}

gener_continue=function(mean=1, sd=0){
  X=abs(rnorm(n, mean=mean, sd=sd))
  return(data.frame(X))
}

gener_binom=function(prob){
  X=rbinom(n, size = 1, prob = prob)
  X=factor(X)
  return(data.frame(X))
}
```


## Différents scénario
Je prend comme généralités que :
 - pour les binomiales, 1 corresponds à l'évènement d'intérêt et qu'il est meilleur d'avoir 0 que 1
 - pour les tte, plus un évènement est censuré moins il est bon (à voir encore)
 - pour les continues, il n'y a que des valeurs positives et une valeur plus grande est préférable
 
 Les notations des vecteurs T et C sont les suivantes : T_scénario_cas de figure (resp C_scénario_cas de figure)
 où le scénario varie entre 1 et 3 et les cas de figure entre 1 et 6 comme suit :
  - 1 : tte/tte 
  - 2 : tte/continue 
  - 3 : tte/binaire 
  - 4 : continue/continue 
  - 5 : continue/binaire 
  - 6 : binaire/binaire 

### Scénario 1 : T uniformément meilleur que C

```{r}
# tte/tte
#T_1_1=gener_tte(0.8, 2.5)
T_1_1=cbind(gener_tte(1.1, 0.5),gener_tte(0.75,0.33))
C_1_1=cbind(gener_tte(0.8, 2.5),gener_tte(0.33,2.5))

# tte/continue
T_1_2=cbind(gener_tte(0.75, 0.75),gener_continue(2,1))
C_1_2=cbind(gener_tte(0.75,1.5),gener_continue(0,1))

# tte/binaire
T_1_3=cbind(gener_tte(0.75,0.5),gener_binom(0.75))
C_1_3=cbind(gener_tte(0.33,2.3),gener_binom(0.45))

# continue/continue
T_1_4=cbind(gener_continue(3,1),gener_continue(3,2))
C_1_4=cbind(gener_continue(2,1),gener_continue(1,1))

# continue/binaire
T_1_5=cbind(gener_continue(2.5,1),gener_binom(0.65))
C_1_5=cbind(gener_continue(0,2),gener_binom(0.35))

# binaire/binaire
T_1_6=cbind(gener_binom(0.75), gener_binom(0.65))
C_1_6=cbind(gener_binom(0.45), gener_binom(0.5))

```

La visulaisation sert à vérifier si les valeurs correspondent bien au scénario choisis

```{r, visualisation}
#### tte/tte
data11=as.data.frame(cbind(T_1_1[[1]],C_1_1[[1]]))
data_long11 <- data11 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long11, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()+labs(title = "tte/tte 1")

data12=as.data.frame(cbind(T_1_1[[3]],C_1_1[[3]]))
data_long12 <- data12 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long12, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()+labs(title = "tte/tte 2")

#### tte/continue

data2=as.data.frame(cbind(T_1_2[[1]],C_1_2[[1]]))
data_long2 <- data2 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long2, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()+labs(title = "tte/continue")

#### tte/binaire

data3=as.data.frame(cbind(T_1_3[[1]],C_1_3[[1]]))
data_long3 <- data3 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long3, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()+labs(title = "tte/binaire")

#### continue/continue

data41=as.data.frame(cbind(T_1_4[,1], C_1_4[,1]))

data_long41 <- data41 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long41, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()

data42=as.data.frame(cbind(T_1_4[,2], C_1_4[,2]))

data_long42 <- data42 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long42, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic() +labs(title = "continue/continue 2")

#### continue/binaire

data5=as.data.frame(cbind(T_1_5[,1],C_1_5[,1]))
data_long5 <- data5 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 

ggplot(data_long5, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic()+labs(title = "continue/binaire")

#### binaire/binaire

data6=as.data.frame(cbind(T_1_6[,1],C_1_6[,1]))
data_long6 <- data6 %>%
  mutate(Groupe_T = "T", Groupe_C = "C") %>%
  tidyr::pivot_longer(cols = c(V1, V2), names_to = "Variable", values_to = "Valeur") %>%
  mutate(Groupe = ifelse(Variable == "V1", "T", "C")) 


ggplot(data_long6, aes(x = Valeur, fill = Groupe)) +
  geom_histogram(bins = 20, alpha = 0.5, color = "black", position = "identity") +
  scale_fill_manual(values = c("T" = "darkblue", "C" = "darkred"), name = "Groupe") +
  theme_classic() +labs(title = "binaire/binaire")
```

### Scénario 2 : C uniformément meilleur que T

```{r}
# tte/tte
T_2_1=cbind(gener_tte(0.5),gener_tte(0.33))
C_2_1=cbind(gener_tte(1.5),gener_tte(1))

# tte/continue
T_2_2=cbind(gener_tte(0.33),gener_continue(0))
C_2_2=cbind(gener_tte(1.5),gener_continue(2))

# tte/binaire
T_2_3=cbind(gener_tte(0.5),gener_binom(0.75))
C_2_3=cbind(gener_tte(1.5),gener_binom(0.45))

# continue/continue
T_2_4=cbind(gener_continue(0),gener_continue(0))
C_2_4=cbind(gener_continue(2),gener_continue(2))

# continue/binaire
T_2_5=cbind(gener_continue(0),gener_binom(0.75))
C_2_5=cbind(gener_continue(2),gener_binom(0.45))

# binaire/binaire
T_2_6=cbind(gener_binom(0.75), gener_binom(0.75))
C_2_6=cbind(gener_binom(0.45), gener_binom(0.45))
```


### Scénario 3 : T similaire à C

```{r}
# tte/tte
T_3_1=cbind(gener_tte(0.5),gener_tte(0.5))
C_3_1=cbind(gener_tte(0.5),gener_tte(0.5))

# tte/continue
T_3_2=cbind(gener_tte(0.5),gener_continue(2))
C_3_2=cbind(gener_tte(0.5),gener_continue(2))

# tte/binaire
T_3_3=cbind(gener_tte(0.5),gener_binom(0.45))
C_3_3=cbind(gener_tte(0.5),gener_binom(0.45))

# continue/continue
T_3_4=cbind(gener_continue(2),gener_continue(2))
C_3_4=cbind(gener_continue(2),gener_continue(2))

# continue/binaire
T_3_5=cbind(gener_continue(2),gener_binom(0.45))
C_3_5=cbind(gener_continue(2),gener_binom(0.45))

# binaire/binaire
T_3_6=cbind(gener_binom(0.45), gener_binom(0.45))
C_3_6=cbind(gener_binom(0.45), gener_binom(0.45))
```



```{r}
extract_value_tte <- function(vecteur) {
nom_vecteur <- deparse(substitute(vecteur))
  
  if (grepl("[123]$", nom_vecteur)) {
    return(vecteur[c(1, 3)])
  } else {
    return(vecteur) 
  }
}
```

## GPC



```{r}

type_variable <- function(vecteur1, L) {
  type <- rep(0, L)
  
  type <- sapply(vecteur1, function(x) {
    classe <- class(x)
    
    if ("Surv" %in% classe) {
      return("tte")
    } else if ("numeric" %in% classe) {
      return("continue")
    } else {
      return("binaire")
    }
  })
  
  return(unname(type))
}
type_variable(T_1_1,2)
type_variable(C_1_1,2)
```



```{r}
extract_tte=function(vecteur1,l){
  t_obs=vecteur1[[l]][,1]
  censure=vecteur1[[l]][,2]
  return(cbind(t_obs,censure))
}
```

```{r}
affect_value_GPC_WO_WR <- function(vecteur1, vecteur2, L, w = rep(1, L), threshold = 0) {
  n1 <- nrow(vecteur1)
  n2 <- nrow(vecteur2)


  type1 <- type_variable(vecteur1, L)
  type2 <- type_variable(vecteur2, L)

  if (!all(type1 == type2)) {
    stop("Les deux vecteurs ont des outcomes de types différents")
  }

  paire <- matrix("", nrow = n1 * n2, ncol = L)
  Delta <- 0
  cpt <- 0
  N_w <- 0
  N_l <- 0
  N_t <- 0
  p <- 1 


 for (i in 1:n1) {
  for (j in 1:n2) {
    for (l in 1:L) {
      if (type1[l] == "tte") {
        t_obs1 = extract_tte(vecteur1, l)[,1]
        censure1 = extract_tte(vecteur1, l)[,2]
        t_obs2 = extract_tte(vecteur2, l)[,1]
        censure2 = extract_tte(vecteur2, l)[,2]
        diff_tte <- t_obs1[i] - t_obs2[j]
        
        if (censure1[i] == 0 && censure2[j] == 0) {
          if (diff_tte > threshold) {
            paire[p, l] = "favorable"
          } else if (diff_tte < -threshold) {
            paire[p, l] = "défavorable"
          } else {
            paire[p, l] = "neutre"
          }
        } else if (censure1[i] == 1 && censure2[j] == 0) {
          if (diff_tte > threshold) {
            paire[p, l] = "favorable"
          } else {
            paire[p, l] = "non-informative"
          }
        } else if (censure1[i] == 0 && censure2[j] == 1) {
          if (diff_tte > threshold) {
            paire[p, l] = "non-informative"
          } else {
            paire[p, l] = "défavorable"
          }
        } else {
          paire[p, l] = "non-informative"
        }
      }
      
      if (type1[l] == "continue") {
        diff <- vecteur1[i, l] - vecteur2[j, l]
        if (diff > threshold) {
          paire[p, l] = "favorable" 
        } else if (diff < -threshold) {
          paire[p, l] = "défavorable"
        } else {
          paire[p, l] = "neutre"
        }
      }
      
      if (type1[l] == "binaire") {
        if (vecteur1[i, l] == 1 && vecteur2[j, l] == 0) {
          paire[p, l] = "favorable"
        } else if (vecteur1[i, l] == 0 && vecteur2[j, l] == 1) {
          paire[p, l] = "défavorable"
        } else {
          paire[p, l] = "neutre"
        }
      }
    }
    p <- p + 1 
  }
  }


 for (p in 1:(n1 * n2)) {
  valeur_trouvee <- FALSE 

  for (l in 1:L) {
    if (paire[p, l] != "non-informative") {
      if (paire[p, l] == "favorable") {
        N_w <- N_w + 1
      } else if (paire[p, l] == "défavorable") {
        N_l <- N_l + 1
      } else if (paire[p, l] == "neutre") {
        N_t <- N_t + 1
      }
      valeur_trouvee <- TRUE
      break  
    }
  }
}
  
  # Calcul des statistiques finales
  print(paire)
  count_non_informative_pairs <- sum(paire[, 1] == "non-informative" & paire[, 2] == "non-informative")
  cat("Nb de paire non-informative : ",count_non_informative_pairs,"\n")
  cat("Nb de win",N_w,"\n")
  cat("Nb de lose : ",N_l,"\n")
  cat("Nb de tie : ",N_t,"\n")
  cat("Nb de paire regardé :", count_non_informative_pairs+N_w+N_l+N_t,"\n")
  Delta <- (N_w - N_l) / (n1 * n2)
  WR <- ifelse(N_l != 0, N_w / N_l, NA)
  WO <- ifelse(N_t != 0, (N_w + 0.5 * N_t) / (N_l + 0.5 * N_t), WR)
  P_w=(N_w)/(N_w+N_l)
  P_L=P_w-1.96*sqrt((P_w*(1-P_w))/(N_w+N_l))
  P_U=P_w+1.96*sqrt((P_w*(1-P_w))/(N_w+N_l))
  CI=c(P_L,P_U)
  CI_wr=c(P_L/(1-P_L),P_U/(1-P_U))

  # Résultat
  data1 <- data.frame(WinRatio = WR, Win_Prop = P_w, WinOdds = WO, GPC = Delta)
  data2 = data.frame(row.names = c("Win proportion", "Win ratio"),lower=c(P_L,P_L/(1-P_L)), upper=c(P_U,P_U/(1-P_U)))
  
  return(list(
  "Tableau des résultats" = data1,
  "Intervalle de confiance à 95%" = data2
))
}


affect_value_GPC_WO_WR(T_1_4, C_1_4, 2)
```


```{r, echo=TRUE}
# à préciser : 
# vecteur1 : le vecteur du nouveau traitement
# vecteur2 : le vecteur du traitement de contrôle
# L le nombre d'outcome
# w : le poids associé à chaque outcome ; par défault valant 1 pour chaque outcome
# threshold : le seuil ; par défault valant 0

affect_value_GPC2=function(vecteur1,vecteur2,L,w=rep(1,L), threshold=0){
  
  cpt=rep(0,L)
  delta=rep(0,L)
  Delta=0
  
  if (length(vecteur1) != length(vecteur2)){
    return("Problème, les vecteurs ne sont pas de la même")
  }

  
  if (length(vecteur1)==4) { # tte/tte
    for(i in 1:length(vecteur1[,1])){
      for (j in 1:length(vecteur2[,1])){
        
        if(vecteur1[i,2]==1 && vecteur2[j,2]==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){cpt[1]=cpt[1]}
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
} #
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        }#
        }
        
        if(vecteur1[i,2] ==1 && vecteur2[j,2] ==0){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
}#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
}#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==0){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
}#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
}#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){
        
        if(vecteur1[i,4]==1 && vecteur2[j,4]==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==1){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]+1}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
        if(vecteur1[i,4] ==1 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]-1}
        }
        
        if(vecteur1[i,4] ==0 && vecteur2[j,4] ==0){
          
          if(vecteur1[i,2] - vecteur2[j,2] > threshold){cpt[2]=cpt[2]}
          else if(abs(vecteur1[i,2] - vecteur2[j,2]) <= threshold){cpt[2]=cpt[2]}
          else if(vecteur1[i,2] - vecteur2[j,2] < - threshold){cpt[2]=cpt[2]}
        }
        
}#
        }
        
      }
    }
    }
    

  
  if (length(vecteur1)==3 && is.factor(vecteur1[,3])==FALSE) { # tte/continue
    for(i in 1:length(vecteur1[,2])){
      for (j in 1:length(vecteur2[,2])){
        
        if(vecteur1[i,2] ==1 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1; N_w=N_w+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){cpt[1]=cpt[1]}
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1; N_w=N_w+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){    
        
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){    
        
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
        }
        
        if(vecteur1[i,2] ==1 && vecteur2[j,2] ==0){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){    
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){    
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){    
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){    
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
}#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){    

        
        if(vecteur1[i,2] - vecteur2[j,2] > threshold){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
          cpt[2] = cpt[2] - 1
        }
        else if (abs(vecteur1[i,2] - vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
     }#
        }
        
      }
      }
  }
  
  
    if (length(vecteur1)==3 && is.factor(vecteur1[,3])) {# tte/binaire
      for(i in 1:length(vecteur1[,2])){
      for (j in 1:length(vecteur2[,2])){
        
        if(vecteur1[i,2] ==1 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1; N_w=N_w+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){cpt[1]=cpt[1]}
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){cpt[1]=cpt[1]+1; N_w=N_w+1}
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
           if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
            cpt[2] = cpt[2] + 1
           } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
              cpt[2] = cpt[2] - 1
           }
           else {cpt[2]=cpt[2]}
          }#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){
            if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
             cpt[2] = cpt[2] + 1
            } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
              cpt[2] = cpt[2] - 1
            }
           else {cpt[2]=cpt[2]}
          }#
        }
        
        if(vecteur1[i,2] ==1 && vecteur2[j,2] ==0){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){
           if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
            cpt[2] = cpt[2] + 1
           } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
             cpt[2] = cpt[2] - 1
            }
            else {cpt[2]=cpt[2]}
          }#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
            if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
            cpt[2] = cpt[2] + 1
            } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
              cpt[2] = cpt[2] - 1
            }
            else {cpt[2]=cpt[2]}

          }#
          else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){cpt[1]=cpt[1]-1}
        }
        
        if(vecteur1[i,2] ==0 && vecteur2[j,2] ==1){
          
          if(vecteur1[i,1] - vecteur2[j,1] > threshold){
            if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
            cpt[2] = cpt[2] + 1
           } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
             cpt[2] = cpt[2] - 1
           }
           else {cpt[2]=cpt[2]}
          }#
          else if(abs(vecteur1[i,1] - vecteur2[j,1]) <= threshold){
            if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
            cpt[2] = cpt[2] + 1
            } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
              cpt[2] = cpt[2] - 1
            } else {cpt[2]=cpt[2]}
            }#
              else if(vecteur1[i,1] - vecteur2[j,1] < - threshold){
               if(vecteur1[i,2] ==1 && vecteur2[j,2]==0){
                  cpt[2] = cpt[2] + 1
                } else if (vecteur1[i,2] ==0 && vecteur2[j,2]==1){
                 cpt[2] = cpt[2] - 1
                }else {cpt[2]=cpt[2]}

          }
        }
        
      }
      }
    }
  
  
  if (length(vecteur1)==2 && is.factor(vecteur1[,1])==F && is.factor(vecteur1[,2])==F) { # continue / continue
    for(i in 1:length(vecteur1[,1])){
      for (j in 1:length(vecteur2[,1])){
        
        if(vecteur1[i,1] - vecteur2[j,1]> threshold){
         cpt[1] = cpt[1] + 1
        } else if (vecteur1[i,1] - vecteur2[j,1] < - threshold){
          cpt[1] = cpt[1] - 1

        }
        else if (abs(vecteur1[i,1]-vecteur2[j,1])<= threshold){
          if(vecteur1[i,2] - vecteur2[j,2]> threshold){
          cpt[2] = cpt[2] + 1
          } else if (vecteur1[i,2] - vecteur2[j,2] < - threshold){
            cpt[2] = cpt[2] - 1
          }
         else if (abs(vecteur1[i,2]-vecteur2[j,2])<= threshold){cpt[2]=cpt[2]}
      }
     }
    }

    print(cpt)
  }
  
    if (length(vecteur1)==2 && is.factor(vecteur1[,1])==FALSE && is.factor(vecteur2[,2])==TRUE) { # continue / binaire
    for(i in 1:length(vecteur1[,1])){
      for (j in 1:length(vecteur2[,1])){
        
        if(vecteur1[i,1] - vecteur2[j,1]> threshold){
         cpt[1] = cpt[1] + 1
        } else if (vecteur1[i,1] - vecteur2[j,1] < - threshold){
          cpt[1] = cpt[1] - 1
        }
        else if (abs(vecteur1[i,1]-vecteur2[j,1])<= threshold){
          if(vecteur1[i,2]==1 && vecteur2[,2][[i]]==0){
          cpt[2] = cpt[2] + 1
          } else if (vecteur1[i,2]==0 && vecteur2[,2][[i]]==1){
            cpt[2] = cpt[2] - 1
          }
          else {cpt[2]=cpt[2]}
          }
     }
    }
    print(cpt)
  }

  
  if (length(vecteur1)==2 && is.factor(vecteur1[,1])==TRUE && is.factor(vecteur2[,2])==TRUE) { # binaire / binaire
    for(i in 1:length(vecteur1[,1])){
      for (j in 1:length(vecteur2[,1])){
        
        if(vecteur1[i,1]==1 && vecteur2[i,1]==0){
         cpt[1] = cpt[1] + 1
        } else if (vecteur1[i,1]==0 && vecteur2[i,1]==1){
          cpt[1] = cpt[1] - 1
        }
        else {if(vecteur1[i,2]==1 && vecteur2[i,2]==0){
         cpt[2] = cpt[2] + 1
        } else if (vecteur1[i,2]==0 && vecteur2[i,2]==1){
          cpt[2] = cpt[2] - 1
        }
        else {cpt[2]=cpt[2]}}
     }
    }
    
    print(cpt)
  }
  
  
  delta[1]=(cpt[1])/(n*n)
  delta[2]=(cpt[2])/(n*n)
  
  Delta=(delta[1]+w*delta[2])

  
  return(c(cpt,delta,Delta))
}
```

```{r}
comp1=affect_value_GPC2(T_1_1, C_1_1)
comp2=affect_value_GPC2(T_1_2, C_1_2)
comp3=affect_value_GPC2(T_1_3, C_1_3)
comp4=affect_value_GPC2(T_1_4, C_1_4)
comp5=affect_value_GPC2(T_1_5, C_1_5)
comp6=affect_value_GPC2(T_1_6, C_1_6)


data <- data.frame(
  "Cas de figure" = c("tte/tte", "tte/continue", "tte/binaire", "continue/continue", "continue/binaire", "binaire/binaire"),
  "Valeur de Delta" = c(comp1[5], comp2[5], comp3[5], comp4[5], comp5[5], comp6[5]),
  "Valeur de delta(1)" = c(comp1[3], comp2[3], comp3[3], comp4[3], comp5[3], comp6[3]),
  "Valeur de delta(2)" = c(comp1[4], comp2[4], comp3[4], comp4[4], comp5[4], comp6[4]),
  "Valeur de p_ij(1)" = c(comp1[1], comp2[1], comp3[1], comp4[1], comp5[1], comp6[1]),
  "Valeur de p_ij(2)" = c(comp1[2], comp2[2], comp3[2], comp4[2], comp5[2], comp6[2])
)

print(data)
wilcox.test(T_1_4[,1],C_1_4[,1])
wilcox.test(T_1_5[,1],C_1_5[,1])
gehan.test(
  time = c(T_1_1[,1], C_1_1[,1]),  # Temps jusqu'à l'événement pour les deux groupes
  event = c(T_1_1[,2], C_1_1[,2]),  # Indicateurs de censure pour les deux groupes
  trt = rep(c(1, 0), c(length(T_1_1[,1]), length(C_1_1[,1]))) # Création du vecteur de traitement
)
```


## Win ratio 

```{r}
temps <- c(5, 10, 15, 20, 25)
statut <- c(1, 0, 1, 0, 1)

T_1_1 <- Surv(time = temps, event = statut)
T_1_1[,2]

# Accéder aux données de statut dans un objet Surv
statut_values <- T_1_1[, 2]  # Ou utiliser T_1_1$status directement

# Séparer les événements non censurés (statut == 1)
non_censure <- T_1_1[statut_values == 1, ]

# Séparer les événements censurés (statut == 0)
censure <- T_1_1[statut_values == 0, ]

# Affichage des résultats
print("Valeurs non censurées :")
print(non_censure)

print("Valeurs censurées :")
print(censure)
```


